/** @preserve https://github.com/easeway/data-drive.js */
!function(t){"use strict";var e={VERSION:"2.1.0"};e.defClass=function(t,e){if(typeof t!="function"){e=t;t=Object}if(!e){e={}}e.__proto__=t.prototype;var i=function(){if(typeof this.constructor=="function"){this.constructor.apply(this,arguments)}};i.prototype=e;return i};e.NotImplementedError=e.defClass(Error,{constructor:function(t){this.super.constructor.call(this,"Not implemented: "+t)}});var i=e.defClass({constructor:function(){this.tests=[]},get ok(){return this.compatible},get compatible(){this._testOnDemand();return this._compatible},get report(){this._testOnDemand();return this._compatible},register:function(t,e){this.tests.push({name:t,test:e});delete this._report;delete this._compatible},test:function(){var t={},e=0;this.tests.forEach(function(i){var n={};try{if(i.test(n)){n.ok=true}}catch(r){n.error=r;delete n.ok}if(!n.ok)e++;t[i.name]=n});this._report=t;this._compatible=e==0},_testOnDemand:function(){if(!this._report){this.test()}}});e.compatibility=new i;var n=t.DataDrive||t.DD;if(n&&n.settings){e.settings=n.settings}else{e.settings={}}t.DataDrive=t.DD=e}(window);!function(t){"use strict";t.Observer=t.defClass({constructor:function(t){this.context=t||this;this.listeners=[]},add:function(t){this.listeners.push(t);return this},remove:function(t){var e=this.listeners.indexOf(t);if(e>=0){this.listeners.splice(e,1)}return this},notify:function(){var t=this.context;var e=arguments;this.listeners.forEach(function(i){i.apply(t,e)});return this}});t.Listener=t.defClass({constructor:function(t,e){this.observer=null;this.callback=t;this.context=e;var i=this;this._notifier=function(){i.onNotify.apply(i,arguments)}},listen:function(t){if(this.observer){this.observer.remove(this._notifier)}this.observer=t;if(this.observer){this.observer.add(this._notifier)}},shutdown:function(){this.listen(null)},get listening(){return this.observer!=null},onNotify:function(){if(typeof this.callback=="function"){var t=this.context||this;this.callback.apply(t,arguments)}}})}(DataDrive);!function(t){"use strict";function e(t,e,i,n){var r=[].slice.call(i,0);r.push(n);return t.apply(e,r)}var i=t.defClass({constructor:function(){this.extensions={}},connect:function(t,e){var i=this.extensions[t];if(!i){this.extensions[t]=i=[]}i.push(e);return this},use:function(t,i){var n=this.extensions[t];if(!n){return function(){return undefined}}if(typeof i=="function"){return function(){var t=arguments;return n.reduce(function(n,r){return e(i,r,t,n)},undefined)}}else{return function(){var t=arguments;return n.reduce(function(n,r){var s=r[i];if(typeof s=="function"){return e(s,r,t,n)}return n},undefined)}}}});t.extensions=new i}(DataDrive);!function(t){"use strict";var e=t.defClass(t.Observer,{constructor:function(){t.Observer.prototype.constructor.call(this);this.__s={caching:false,cachedRev:null,cachedVal:null,valueRev:0}},get value(){if(!this.__s.caching){return this.getVal()}if(this.__s.cachedRev===this.__s.valueRev){return this.__s.cachedVal}this.__s.cachedVal=this.getVal();this.__s.cachedRev=this.__s.valueRev;return this.__s.cachedVal},set value(t){var e=this.value;var i=this.setVal(t);this.flush({change:"update",oldVal:e,newVal:i})},query:function(t,e){var i;if(Array.isArray(t)){i=t}else{i=t.split(".")}var n=this,r=undefined;for(var s=0;s<i.length;s++){if(i[s]=="")continue;if(typeof n.findProperty=="function"){var o=n.findProperty(i[s]);if(o){n=o;continue}}r=i.slice(s);break}if(typeof e=="function"){return e(n,r)}return r?null:n},flush:function(t){if(this.__s.caching){this.__s.cachedVal=null;this.__s.valueRev++}if(t){t.data=this;this.notify(t)}return this},refresh:function(){return this.notify({change:"update",refresh:true,data:this})}});function i(t){if(typeof t=="function"){return t()}return t}var n=t.defClass(e,{constructor:function(t,n){e.prototype.constructor.call(this);this.__s.defaultVal=t==undefined?null:t;this.__s.value=i(n==undefined?this.__s.defaultVal:n)},getVal:function(){return this.__s.value},setVal:function(t){return this.__s.value=t==undefined||t==null?i(this.__s.defaultVal):t}});var r=t.defClass(e,{constructor:function(t){e.prototype.constructor.call(this);this.isList=true;this.itemType=t;this.items=[]},findProperty:function(t){var e=parseInt(t);return isNaN(e)?null:this.items[e]},getVal:function(){return this.items.map(function(t){return t.value})},setVal:function(t){if(Array.isArray(t)){var e=[];this.items=this._createItems(t,function(t){e.push(t)});return e}else if(t===null||t===undefined){this.items=[];return[]}throw new TypeError("items is not an Array")},refresh:function(){this.items.forEach(function(t){t.refresh()});return e.prototype.refresh.call(this)},get length(){return this.items.length},at:function(t){return this.items[t]},valAt:function(t){var e=this.at(t);return e?e.value:undefined},update:function(t,e){if(e&&!Array.isArray(e)){e=[e]}if(Array.isArray(e)&&e.length>0){var i=[],n=null,r;for(var s in e){var a=parseInt(s);if(isNaN(a))continue;var c=this.at(a+t);if(c==undefined&&e[s]==undefined)continue;if(n==null){n=t+a;r=a}if(e[s]==undefined){delete this.items[a+t]}else if(c==undefined){var u=o.createValue(this.itemType);u.value=e[s];this.items[a+t]=u}else{c.value=e[s]}i[a-r]=this.items[a+t]}if(n){this.flush({change:"items",op:"update",index:n,items:i})}}return this},insert:function(t,e){if(e&&!Array.isArray(e)){e=[e]}if(Array.isArray(e)&&e.length>0){var i=this._createItems(e);this.items.splice.apply(this.items,[t,0].concat(i));this.flush({change:"items",op:"insert",index:t,items:i})}return this},remove:function(t,e){if(!e)e=1;else if(e<0)e=this.items.length-t;var i=this.items.splice(t,e);this.flush({change:"items",op:"remove",index:t,items:i});return this},append:function(t){return this.insert(this.items.length,t)},_createItems:function(t,e){if(!e)e=function(){};var i=this.itemType;return t.map(function(t){var n=o.createValue(i);e(n.value=t);return n})}});var s=t.defClass(e,{constructor:function(t){e.prototype.constructor.call(this);this._properties={};if(t instanceof a){this._schema=t;for(var i in t.descriptor){this.define(i,t.descriptor[i])}t.modelCreated(this)}},define:function(t,e){var i=o.createValue(e);var n=this;Object.defineProperty(this,t,{get:function(){return i.isList?i:i.value},set:function(e){var r=i.value=e;n.flush({change:"property",name:t,value:r});return r}});this._properties[t]=i;return i},findProperty:function(t){return this._properties[t]},getVal:function(){var t={};for(var e in this._properties){var i=this._schema?this._schema.mapName(e):e;t[i]=this._properties[e].value}return t},setVal:function(t){var e={};for(var i in this._properties){var n=this._schema?this._schema.mapName(i):i;e[n]=this._properties[i].value=t?t[n]:null}return e},refresh:function(){for(var t in this._properties){this._properties[t].refresh()}return e.prototype.refresh.call(this)}});var o=t.defClass({createValue:function(){throw new t.NotImplementedError("createValue")}});o.createValue=function(t){var i;if(!t){i=new n}else if(Array.isArray(t)){i=new r(t[0])}else if(t instanceof o){i=t.createValue()}else if(t instanceof e){i=t}else{throw new TypeError("type must be instance of DD.Type or DD.Value")}return i};var a=t.defClass(o,{constructor:function(e,i){this.descriptor=e;this.options=i||{};this.nameMap=i&&i.mappings?i.mappings:{};t.extensions.use("Schema","options")(i,this)},createValue:function(){return new s(this)},modelCreated:function(e){t.extensions.use("Schema","modeling")(e,this)},mapName:function(t){return this.nameMap[t]==undefined?t:this.nameMap[t]}});var c=t.defClass(o,{constructor:function(t){if(t&&t.initialVal){this.initialVal=t.initialVal}if(t&&t.defaultVal){this.defaultVal=t.defaultVal}},createValue:function(){return new n(this.defaultVal,this.initialVal)}});t.Value=e;t.Scalar=n;t.List=r;t.Model=s;t.Type=o;t.ScalarType=c;t.Schema=a;t.Types={Scalar:new c};t.ModelRegistry=t.defClass(s,{constructor:function(){s.prototype.constructor.call(this)},register:function(t,e){var i=this._properties[t];if(i){i=this._properties[t]=o.createValue(e)}else{i=this.define(t,e)}return i}});t.Models=new t.ModelRegistry}(DataDrive);!function(DD){"use strict";var BINDING_PROP="__dd_binding";var ATTR_MAP="data-drive-map";var ATTR_ON="data-drive-on";var ATTR_OPTS="data-drive-opts";var ATTR_ATTR="data-drive-attr-";var ATTR_LIST="data-drive-list";function binarySearch(t,e,i,n){if(typeof e!="function"){var r=e;e=function(t){return r-t}}var s=i,o=n,a=0,c=0;if(s==undefined)s=0;if(o==undefined)o=t.length-1;while(s<=o){a=s+o>>1;c=e(t[a]);if(c==0){break}else if(c>0){s=a+1}else{o=a-1}}if(c>0)a++;return a}var SparseIndex=DD.defClass({constructor:function(t){this.indices=Object.keys(t);this.from=0},closest:function(t,e){if(!e)this.from=0;var i=binarySearch(this.indices,t,this.from);this.from=i;return this.indices[i]?parseInt(this.indices[i]):undefined}});function bindingFromNode(t){return t[BINDING_PROP]}var Binding=DD.defClass(DD.Listener,{constructor:function(t,e,i){DD.Listener.prototype.constructor.call(this);this.root=t;this.scope=e;this.element=i.element;this.node=i.node;this.options=i.options||{};this.handlers=[];if(i.contents){this.contents=i.contents;this.handlers.push(function(t){this.node.textContent=this.contents.evaluate(this,t)})}else{if(i.attrs){this.attrs=i.attrs;this.handlers.push(function(t){for(var e in this.attrs){this.node.setAttribute(e,this.attrs[e].evaluate(this,t))}})}if(typeof i.script=="function"){this.script=i.script;this.changes=i.changes;this.handlers.push(function(t){if(!this.changes||this.changes[t.change]){this.script.call(this,t,this.data,this.element,this.node)}})}}if(i.dataSource&&i.dataSource[0]!="."){this.data=e.dataRoot.query(i.dataSource)}else{var n=i.data;if(!n){for(var r=this.element;r&&r!=t.parentElement;r=r.parentElement){var s=bindingFromNode(r);if(s){n=s.data;break}}}if(!n){n=e.dataRoot}if(i.dataSource){n=n.query(i.dataSource.substr(1))}this.data=n}if(this.data){if(this.data.isList){if(typeof i.listFactory=="function"){this.listFactory=i.listFactory.call(this,this.data,this.element,this.node)}else{this.listFactory=autoSelectListFactory(this)}}if(this.listFactory||this.handlers.length>0){this.listen(this.data)}}else{console.error("Data model not found: "+i.dataSource)}},get isList(){return!!this.listFactory},unbind:function(){this.shutdown()},onNotify:function(t){if(this.isList){this.listFactory.onChange(t)}this.handlers.forEach(function(e){e.call(this,t)},this)}});function buildFunction(script){var fn;try{return eval("fn = function ($C, $D, $E, $N) { "+script+" }")}catch(e){console.error("Bad script: "+script);console.error(e);throw e}}function buildStatement(script){var fn;try{return eval("fn = function ($C, $D, $E, $N) { return ( "+script+" ); }")}catch(e){console.error("Bad script: "+script);console.error(e);throw e}}var SUBST_REGEX=/%\{[^\}]+\}/g;var ContentTemplate=DD.defClass({constructor:function(t){if(t){this.parse(t)}else{this.contents=[]}},parse:function(t){this.contents=[];SUBST_REGEX.lastIndex=0;var e=0,i,n=0;while((i=SUBST_REGEX.exec(t))!=null){var r=i.index;if(r>e){this.contents.push(t.substr(e,r-e))}e=SUBST_REGEX.lastIndex;this.contents.push(buildStatement(i[0].substr(2,i[0].length-3)));n++}if(n>0){if(e<t.length){this.contents.push(t.substr(e))}}return n>0},get valid(){return this.contents.length>0},evaluate:function(t,e){return this.contents.reduce(function(i,n){if(typeof n=="function"){i+=n.call(t,e,t.data,t.element,t.node)}else{i+=n}return i},"")}});Binding.create=function(t,e,i,n){var r={};if(n.data){r.data=n.data}if(t.nodeType==1){for(var s=0;s<t.attributes.length;s++){var o=t.attributes[s];switch(o.name){case ATTR_MAP:r.dataSource=o.value.trim();r.node=t;break;case ATTR_ON:{var a=o.value.indexOf(":");if(a>=0){r.script=buildFunction(o.value.substr(a+1));r.changes={};var c=o.value.substr(0,a).split(",");var u=0;for(var a=0;a<c.length;a++){var h=c[a].trim();if(h==="*"){r.changes=null;break}else if(h!=""){r.changes[h]=true;u++}}if(u==0){r.changes=null}}else{r.script=buildFunction(o.value);r.changes=null}r.node=t;break}case ATTR_OPTS:r.options=o.value.split(";").reduce(function(t,e){var i=e.indexOf(":");if(i>0){t[e.substr(0,i).trim()]=e.substr(i+1).trim()}return t},{});if(r.options.bind){r.node=t}break;case ATTR_LIST:r.listFactory=buildStatement(o.value);break;default:if(o.name.substr(0,ATTR_ATTR.length)==ATTR_ATTR){var d,f;if((d=o.name.substr(ATTR_ATTR.length)).length>0&&(f=new ContentTemplate(o.value)).valid){if(!r.attrs){r.attrs={}}r.attrs[d]=f;r.node=t}}}}if(r.data){r.node=t}if(r.node){r.element=t}}else{var f=new ContentTemplate(t.textContent);if(f.valid){r.contents=f}if(r.contents||r.data){r.node=t;r.element=t.parentElement||n.container}}if(r.element){return new Binding(e,i,r)}return null};var ListFactory=DD.defClass({constructor:function(t){this.binding=t},get container(){return this.binding.element},get nodesPerItem(){if(Array.isArray(this.nodesTemplate)){return this.nodesTemplate.length}throw new DD.NotImplementedError("nodesPerItem not implemented")},rebuild:function(){this.container.innerHTML="";this.items=this._createItemViews(this.binding.data.items);this.items.forEach(function(t){t.nodes.forEach(function(t){this.container.appendChild(t)},this)},this);return this},onChange:function(t){if(t.change=="update"){this.rebuild()}else if(t.change=="items"&&t.op){var e="onItems"+t.op[0].toUpperCase()+t.op.substr(1);if(typeof this[e]=="function"){this[e].call(this,t.index,t.items)}}},onItemsInsert:function(t,e){var i=this._insertItemViewFn(t);var n=this._createItemViews(e);n.forEach(function(t){i.call(this,t)},this);this.items.splice(t,0,n)},onItemsRemove:function(t,e){var i=new SparseIndex(this.items);var n=i.closest(t);if(n!=undefined){var r=i.closest(t+e.length,true);var s=this.items.slice(n,r);s.forEach(this._removeItemView,this)}this.items.splice(t,e.length)},onItemsUpdate:function(t,e){var i=[];e.forEach(function(e,n){if(!e&&this.items[t+n]){this._removeItemView(this.items[t+n]);i.push(t+n)}else if(e&&!this.items[t+n]){var r=this._insertItemViewFn(t+n);var s=this._createItemViews([e])[0];r.call(this,s);this.items[t+n]=s}},this)},createItemNodes:function(){if(Array.isArray(this.nodesTemplate)){return this.nodesTemplate.map(function(t){return t.cloneNode(true)})}throw new DD.NotImplementedError("createItemNodes not implemented")},_createItemViews:function(t){return t.map(function(t){var e={data:t,nodes:this.createItemNodes()};e.nodes.forEach(function(e){bindDOMTree(e,e,this.binding.scope,{data:t,container:this.container})},this);t.refresh();return e},this)},_findDirectChild:function(t){while(t&&t.parentElement!=this.container){t=t.parentElement}return t},_insertItemViewFn:function(t){var e=new SparseIndex(this.items).closest(t);var i=this._findDirectChild(e!=undefined?this.items[e].nodes[0]:null);var n=i?function(t){this.container.insertBefore(t,i)}:function(t){this.container.appendChild(t)};return function(t){t.nodes.forEach(function(t){n.call(this,t)},this)}},_removeItemView:function(t){t.nodes.forEach(function(t){var e=this._findDirectChild(t);if(e){this.container.removeChild(e)}},this)}});var TemplateListFactory=DD.defClass(ListFactory,{constructor:function(t){ListFactory.prototype.constructor.call(this,t);var e=this.container;if(t.options.item){e=jQuery(t.root).find(t.options.item)[0]}var i=e?e.childNodes:[];this.nodesTemplate=[];for(var n=0;n<i.length;n++){this.nodesTemplate.push(i[n])}this.container.innerHTML=""}});function autoSelectListFactory(t){return new TemplateListFactory(t)}function unbindNode(t){var e=t[BINDING_PROP];if(e){e.unbind();delete t[BINDING_PROP]}}function bindNode(t,e,i,n){if(!n.noUnbind){unbindNode(t)}else if(t[BINDING_PROP]){return true}var r=Binding.create(t,e,i,n);if(r){Object.defineProperty(t,BINDING_PROP,{get:function(){return r},configurable:true,enumerable:false});return true}return false}function traverseDOMTree(t,e,i){if(i==undefined){i=0}switch(t.nodeType){case 1:e(t,i);for(var n=0;n<t.childNodes.length;n++){traverseDOMTree(t.childNodes[n],e,i+1)}break;case 3:e(t,i);break}}function unbindDOMTree(t){traverseDOMTree(t,function(t){unbindNode(t)})}function bindDOMTree(t,e,i,n){traverseDOMTree(t,function(t,r){if(r>0){delete n.data}bindNode(t,e,i,n)})}var DOMObserverClass=window.MutationObserver;if(!DOMObserverClass){DOMObserverClass=window.WebKitMutationObserver}if(!DOMObserverClass){DOMObserverClass=DD.defClass({constructor:function(t){this.callback=t;this.record={removedNodes:[],addedNodes:[]};var e=this;this.handlerNodeUpdated=function(t){e.onNodeChange(e.record.addedNodes,t)};this.handlerNodeRemoved=function(t){e.onNodeChange(e.record.removedNodes,t)}},observe:function(t){this.disconnect();this.observed=t;this.observed.addEventListener("DOMNodeInserted",this.handlerNodeUpdated);this.observed.addEventListener("DOMNodeRemoved",this.handlerNodeRemoved);this.observed.addEventListener("DOMCharacterDataModified",this.handlerNodeUpdated);this.observed.addEventListener("DOMSubtreeModified",this.handlerNodeUpdated);return this},disconnect:function(){if(this.observed){this.observed.removeEventListener("DOMSubtreeModified",this.handlerNodeUpdated);this.observed.removeEventListener("DOMCharacterDataModified",this.handlerNodeUpdated);this.observed.removeEventListener("DOMNodeRemoved",this.handlerNodeRemoved);this.observed.removeEventListener("DOMNodeInserted",this.handlerNodeUpdated);delete this.observed}},onNodeChange:function(t,e){if(t.length==0){var i=this;setTimeout(function(){i.notifyNodeChanges()},0)}t.push(e.target);this.notifyNodeChanges()},notifyNodeChanges:function(){var t={removedNodes:this.record.removedNodes,addedNodes:this.record.addedNodes};this.record.removedNodes=[];this.record.addedNodes=[];this.callback([t])}})}var BindingScope=DD.defClass({constructor:function(t,e){var i=this;this.observer=new DOMObserverClass(function(){i.onMutations.apply(i,arguments)});this.scope(t,e)},refresh:function(t){var e={noUnbind:true};for(var i in t){e[i]=t[i]}bindDOMTree(this.root,this.root,this,e);return this},scope:function(t,e){this.unbind();this.root=t||document.body;this.dataRoot=e||DD.Models;return this},bind:function(t){this.observer.observe(this.root,{childList:true,attributes:true,characterData:true,subtree:true});return t===false?this:this.refresh()},unbind:function(){this.observer.disconnect();if(this.root){unbindDOMTree(this.root)}return this},findBinding:function(t){for(;t&&t!=this.root;t=t.parentElement){var e=bindingFromNode(t);if(e){return e}}return null},onMutations:function(t){var e=this;t.forEach(function(t){var i;for(i=0;t.removedNodes&&i<t.removedNodes.length;i++){unbindDOMTree(t.removedNodes[i])}for(i=0;t.addedNodes&&i<t.addedNodes.length;i++){bindDOMTree(t.addedNodes[i],e.root,e,{noUnbind:true})}})}});DD.ListFactory=ListFactory;DD.TemplateListFactory=TemplateListFactory;DD.BindingScope=BindingScope;DD.binding=bindingFromNode;jQuery(document).ready(function(){if(DD.settings.autobind!=false&&DOMObserverClass){var t=new BindingScope;t.bind();DD.documentScope=t}})}(DataDrive);!function(t){"use strict";var e=function(t,e,i){var n=jQuery.extend({accepts:"application/json"},i||{});var r=n.success;var s=n.modelUpdate;var o=n.dataConvert;delete n.modelUpdate;delete n.dataConvert;n.success=function(e){if(typeof s=="function"){s.call(t,e)}else{if(typeof o=="function"){e=o(e)}t.value=e}if(typeof r=="function"){r.apply(this,arguments)}};t.reload=function(){return jQuery.ajax(e,n)};return t};t.AjaxConnect=e;t.extensions.connect("Schema",{modeling:function(t,i){if(i.options.ajax&&i.options.ajax.url){e(t,i.options.ajax.url,i.options.ajax.settings)}}});t.Value.prototype.ajax=function(t,i){return e(this,t,i)}}(DataDrive);